# 究極の .env ガードマン — 要件定義書

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロダクト名 | Env Guardman |
| 形態 | VS Code 拡張機能 |
| ライセンス | MIT (予定) |
| 対象ユーザー | チーム開発を行うすべての開発者 |
| 公開先 | VS Code Marketplace |

### 1.1 解決する課題

チーム開発において、メンバーが `.env.example` に新しい環境変数を追加した際、他のメンバーがそれに気づかずローカルの `.env` を更新しないまま開発を続け、原因不明のエラーで時間を浪費する問題を解決する。

### 1.2 ソリューション概要

VS Code 上で `.env.example`（テンプレート）と `.env`（実ファイル）の差分を自動検出し、不足している環境変数をユーザーに通知・入力補助する拡張機能を提供する。**すべての処理はローカルで完結**し、秘匿情報が外部に送信されることは一切ない。

---

## 2. 機能要件

### 2.1 自動差分チェック機能

| ID | 要件 | 優先度 |
|----|------|--------|
| F-001 | VS Code でワークスペースを開いた際に `.env.example` と `.env` の差分を自動チェックする | 必須 |
| F-002 | Git ブランチを切り替えた際に差分チェックを自動実行する | 必須 |
| F-003 | `.env.example` または `.env` ファイルが保存された際に差分チェックを自動実行する | 必須 |
| F-004 | コマンドパレットから手動で差分チェックを実行できる | 必須 |

### 2.2 通知・警告機能

| ID | 要件 | 優先度 |
|----|------|--------|
| F-010 | 不足する環境変数がある場合、VS Code 右下に警告通知（Warning）を表示する | 必須 |
| F-011 | 通知には不足している変数名の一覧を表示する | 必須 |
| F-012 | 通知に「今すぐ値を入力する」ボタンを表示する | 必須 |
| F-013 | 不足変数がない場合は通知を表示しない（正常時は静か） | 必須 |
| F-014 | ステータスバーに現在の .env の状態を常時表示する（例: `✓ .env OK` / `⚠ .env: 3 missing`） | 推奨 |

### 2.3 対話的入力・追記機能

| ID | 要件 | 優先度 |
|----|------|--------|
| F-020 | 「今すぐ値を入力する」ボタン押下で、不足変数を1つずつ InputBox で入力させる | 必須 |
| F-021 | InputBox には変数名をプレースホルダーまたはプロンプトとして表示する | 必須 |
| F-022 | `.env.example` にデフォルト値がある場合、InputBox の初期値として表示する | 必須 |
| F-023 | `.env.example` にコメント（`# 説明文`）がある場合、InputBox の説明として表示する | 推奨 |
| F-024 | 入力完了後、`.env` ファイルの末尾に変数を追記する | 必須 |
| F-025 | 入力をスキップした変数はコメントアウト状態（`# KEY=`）で追記する | 推奨 |
| F-026 | 一括入力モード：Webview パネルで全不足変数を一覧表示し、フォーム形式で一括入力できる | 任意 |

### 2.4 .env.example パース仕様

| ID | 要件 | 優先度 |
|----|------|--------|
| F-030 | `KEY=value` 形式の行をパースできる | 必須 |
| F-031 | `KEY=` （値が空）の行をパースできる | 必須 |
| F-032 | `KEY`（`=` なし）の行もキーとして認識する | 推奨 |
| F-033 | `#` で始まる行をコメントとして無視する | 必須 |
| F-034 | 空行を無視する | 必須 |
| F-035 | `"` や `'` で囲まれた値を正しくパースする | 必須 |
| F-036 | インラインコメント（`KEY=value # comment`）を正しく処理する | 推奨 |

### 2.5 設定（Configuration）

| ID | 要件 | 優先度 |
|----|------|--------|
| F-040 | テンプレートファイルパスを設定可能にする（デフォルト: `.env.example`） | 必須 |
| F-041 | チェック対象の `.env` ファイルパスを設定可能にする（デフォルト: `.env`） | 必須 |
| F-042 | 複数の `.env` ペアを設定可能にする（モノレポ対応） | 推奨 |
| F-043 | 無視する変数名のパターンを設定可能にする（例: `["^OPTIONAL_.*"]`） | 推奨 |
| F-044 | ブランチ切り替え時の自動チェックを有効/無効に設定可能にする | 推奨 |
| F-045 | ワークスペース起動時の自動チェックを有効/無効に設定可能にする | 推奨 |

---

## 3. 非機能要件

### 3.1 セキュリティ

| ID | 要件 | 優先度 |
|----|------|--------|
| NF-001 | すべての処理をローカルで完結させること（ネットワーク通信禁止） | 必須 |
| NF-002 | `.env` の内容をログ、テレメトリ、外部サービスに送信しないこと | 必須 |
| NF-003 | 拡張機能のパーミッション（`permissions`）に不要な権限を含めないこと | 必須 |

### 3.2 パフォーマンス

| ID | 要件 | 優先度 |
|----|------|--------|
| NF-010 | 差分チェックは 100ms 以内に完了すること（通常規模の .env ファイル） | 必須 |
| NF-011 | VS Code の起動時間に顕著な影響を与えないこと（遅延アクティベーション） | 必須 |

### 3.3 互換性

| ID | 要件 | 優先度 |
|----|------|--------|
| NF-020 | VS Code 1.85.0 以降をサポートすること | 必須 |
| NF-021 | Windows / macOS / Linux で動作すること | 必須 |
| NF-022 | マルチルートワークスペースに対応すること | 推奨 |

### 3.4 保守性

| ID | 要件 | 優先度 |
|----|------|--------|
| NF-030 | TypeScript で実装すること | 必須 |
| NF-031 | ユニットテストを作成すること（パース処理、差分チェックロジック） | 必須 |
| NF-032 | ESLint + Prettier によるコード品質管理を行うこと | 推奨 |

---

## 4. 技術設計方針

### 4.1 技術スタック

| カテゴリ | 技術 |
|----------|------|
| 言語 | TypeScript |
| 拡張機能基盤 | VS Code Extension API |
| バンドラー | esbuild (webpack も可) |
| テスト | Vitest (もしくは Mocha) |
| パッケージマネージャ | npm |

### 4.2 アクティベーションイベント

```jsonc
"activationEvents": [
  "workspaceContains:**/.env.example"
]
```

ワークスペースに `.env.example` が存在する場合のみアクティベーションし、不要なリソース消費を防ぐ。

### 4.3 イベントトリガー設計

| トリガー | VS Code API | 処理 |
|----------|-------------|------|
| ワークスペース起動 | `vscode.workspace.onDidOpenTextDocument` / `activate()` | 起動時チェック |
| ブランチ切り替え | `vscode.workspace.createFileSystemWatcher('.git/HEAD')` | HEAD 変更を監視 |
| ファイル保存 | `vscode.workspace.onDidSaveTextDocument` | `.env.example` or `.env` の保存を検知 |
| 手動実行 | `vscode.commands.registerCommand` | コマンドパレット経由 |

### 4.4 主要モジュール構成

```
src/
├── extension.ts          # エントリポイント（activate / deactivate）
├── checker/
│   ├── envParser.ts      # .env ファイルのパースロジック
│   ├── diffChecker.ts    # テンプレートと実ファイルの差分検出
│   └── types.ts          # 型定義
├── ui/
│   ├── notification.ts   # 通知・ポップアップ表示
│   ├── inputWizard.ts    # 対話的入力フロー
│   └── statusBar.ts      # ステータスバー表示
├── watcher/
│   ├── fileWatcher.ts    # ファイル保存監視
│   └── gitWatcher.ts     # ブランチ切り替え監視
├── config/
│   └── settings.ts       # 設定値の読み込み
└── test/
    ├── envParser.test.ts
    └── diffChecker.test.ts
```

---

## 5. ユーザーフロー

### 5.1 基本フロー（ワークスペース起動時）

```
1. ユーザーが VS Code でプロジェクトを開く
2. ワークスペースに .env.example が存在するか確認
   → 存在しなければ何もしない
3. .env.example をパースしてキー一覧を取得
4. .env をパースしてキー一覧を取得
   → .env が存在しなければ全キーが不足として扱う
5. 差分（.env.example にあるが .env にないキー）を算出
6. 差分がなければ終了（ステータスバーに ✓ 表示）
7. 差分があれば警告通知を表示
   → 「今すぐ値を入力する」ボタンを含む
8. ボタン押下 → 不足変数ごとに InputBox を順次表示
9. 入力値を .env に追記
10. 追記完了後、ステータスバーを更新
```

### 5.2 ブランチ切り替え時フロー

```
1. .git/HEAD ファイルの変更を FileSystemWatcher で検知
2. 短いディレイ（debounce 500ms）を設けてチェック実行
   → ブランチ切り替え直後はファイルが安定するまで待つ
3. 以降は基本フロー 3〜10 と同一
```

---

## 6. 設定項目一覧

```jsonc
{
  // テンプレートファイルパス（ワークスペースルートからの相対パス）
  "envGuardman.templateFile": ".env.example",

  // チェック対象 .env ファイルパス
  "envGuardman.envFile": ".env",

  // 複数ペア設定（モノレポ用）
  "envGuardman.filePairs": [],

  // 無視する変数名パターン（正規表現）
  "envGuardman.ignorePatterns": [],

  // ワークスペース起動時の自動チェック
  "envGuardman.checkOnOpen": true,

  // ブランチ切り替え時の自動チェック
  "envGuardman.checkOnBranchSwitch": true,

  // ファイル保存時の自動チェック
  "envGuardman.checkOnSave": true
}
```

---

## 7. コマンド一覧

| コマンド ID | 表示名 | 説明 |
|------------|--------|------|
| `envGuardman.check` | Env Guardman: Check Missing Variables | 手動で差分チェックを実行 |
| `envGuardman.addMissing` | Env Guardman: Add Missing Variables | 不足変数の入力ウィザードを起動 |

---

## 8. 将来的な拡張案（スコープ外）

以下は初回リリースのスコープ外とするが、将来のバージョンで検討する。

| 案 | 概要 |
|----|------|
| `.env.local` / `.env.development` 対応 | 環境別ファイルとの差分チェック |
| 余剰変数の検出 | `.env` にあるが `.env.example` にないキーの警告 |
| DiagnosticsProvider 連携 | エディタ上で直接 `.env` ファイルに波線警告を表示 |
| Docker / docker-compose 連携 | `docker-compose.yml` の `environment` セクションとの整合性チェック |
| 暗号化サポート | `.env` ファイルの暗号化・復号（SOPS 等との連携） |

---

## 9. 用語定義

| 用語 | 定義 |
|------|------|
| テンプレートファイル | `.env.example` など、必要な環境変数の一覧を定義したファイル |
| 実ファイル | `.env` など、実際の値が記載されたファイル |
| 不足変数 | テンプレートファイルに存在し、実ファイルに存在しない環境変数キー |
| 差分チェック | テンプレートファイルと実ファイルのキー比較処理 |
